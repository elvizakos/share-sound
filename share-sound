#!/bin/bash

selfip="$(ip -o -4 route show | grep -o -E "src\s+([0-9]{1,3}[.]){3}[0-9]{1,3}" | head -1 | cut -d' ' -f2)"
ipset="false"
port="4656"
action="set client"
	
## Read command line:
while [ $# -gt 0 ]; do

	key="$1"

	case "$1" in

		connect|c)
			action="set client"
			shift
			;;

		listen|l|server)
			action="set server"
			shift
			;;

		list|ls)
			action="list"
			shift
			;;
		
		del|delete)
			action="delete"
			shift
			;;

		--port=*)
			port="${key:7}"
			shift
			;;

		--port)
			shift
			port="$1"
			shift
			;;

		--ip-auto)
			ip="$selfip"
			shift
			;;

		--ip=*)
			ip="${key:5}"
			shift
			;;

		--ip)
			shift
			ip="$1"
			shift
			;;
	esac

done

if [ "$action" == "set client" ]; then

	# export PULSE_SERVER=tcp:$ip:$port
	#pactl load-module module-tunnel-sink server=tcp:$ip:$port
	pactl load-module module-tunnel-sink server=tcp:$ip:$port tsched=1 rate=48000 format=s16le channels=2 latency_msec=100
	pactl set-default-sink "$(pactl list short sources | grep "$ip" | cut -d$'\t' -f1)"

elif [ "$action" == "set server" ]; then

	pactl load-module module-native-protocol-tcp port="$port" listen="$ip" auth-anonymous=true

elif [ "$action" == "delete" ]; then

	sid="$(pactl list short | grep 'server=' | cut -d$'\t' -f1 | head -n1)"
	[ "$sid" != "" ] && pactl unload-module "$sid"
	sid="$(pactl list short | grep 'listen=' | cut -d$'\t' -f1 | head -n1)"
	[ "$sid" != "" ] && pactl unload-module "$sid"

elif [ "$action" == "list" ]; then

	pactl list short sources

fi
